window.onload = function() {
    
    "use strict";
    
    
    var game = new Phaser.Game( 640, 640, Phaser.CANVAS, 'game', { preload: preload, create: create, update: update, render: render} );
    
    function preload() {
       game.load.tilemap('street', 'assets/street.json', null, Phaser.Tilemap.TILED_JSON);
       game.load.image('streetTiles', 'assets/tileSet.png');
       game.load.tilemap('dealer', 'assets/dealership.json', null, Phaser.Tilemap.TILED_JSON);
       game.load.image('dealerTiles', 'assets/dealershipTileset.png');
       game.load.image('door', 'assets/door.png');
       game.load.image('door2', 'assets/door2.png');
       game.load.image('doorS', 'assets/doorS.png');
       game.load.image('dude', 'assets/dude.png');
       game.load.image('exit', 'assets/exit.png');
       //load the cars
       game.load.image('carB', 'assets/carB.png');
       game.load.image('carB2', 'assets/carB2.png');
       game.load.image('carG', 'assets/carG.png');
       game.load.image('carG2', 'assets/carG2.png');
       game.load.image('carR', 'assets/carR.png');
       game.load.image('carR2', 'assets/carR2.png');
    }
    var map;
    var blockTile;
    var door, door2, doorS, exit;
    var player, player2;
    var cursors;
    var carB, carB2, carG, carG2, carR, carR2;
    var cam;
    
   function create(){
   	  loadStreet();
   	  player2 = game.add.sprite(500, 500, 'dude');
   	   game.physics.arcade.enable(player2);
   	   player2.kill();
   	  cursors = game.input.keyboard.createCursorKeys();
   	  game.camera.follow(player);
   }
    
   function update(){
    	   game.physics.arcade.collide(player, blockTile);
    	   game.physics.arcade.overlap(player, door, enterD, null, this);
    	   game.physics.arcade.overlap(player, door2, enterD, null, this);
    	   game.physics.arcade.overlap(player, doorS, enterS, null, this);
    	   game.physics.arcade.overlap(player, exit, exitD, null, this);
   	   if(player.alive){
		   player.body.velocity.x = 0;
		   player.body.velocity.y = 0;
		   if(cursors.left.isDown){
			   player.body.velocity.x = -280;
		   }
		   else if(cursors.right.isDown){
			   player.body.velocity.x = 280;
		   }
		   if(cursors.up.isDown){
			   player.body.velocity.y = -280;
		   }
		   else if(cursors.down.isDown){
			   player.body.velocity.y = 280;
		   }
   	   }
   	   if(player2.alive){
		   player2.body.velocity.x = 0;
		   player2.body.velocity.y = 0;
		   if(cursors.left.isDown){
			   player2.body.velocity.x = -280;
		   }
		   else if(cursors.right.isDown){
			   player2.body.velocity.x = 280;
		   }
		   if(cursors.up.isDown){
			   player2.body.velocity.y = -280;
		   }
		   else if(cursors.down.isDown){
			   player2.body.velocity.y = 280;
		   }
   	   }
   }
   function enterD(play, doo){
   	   game.camera.reset();
   	   player.kill();
   	   loadDealer();
   	   game.camera.follow(player2);
   	   
   	   
   }
   function enterS(play, doo){
   	   loadS();
   }
   function exitD(play, doo){
   	   player2.destroy();
   	   loadStreet(); 
   }
   
   function loadStreet(){
   	   map = game.add.tilemap('street');
   	   map.addTilesetImage('tileSet', 'streetTiles');
   	   var backgroundLayer = map.createLayer('background');
   	   blockTile = map.createLayer('blocked');
   	   map.setCollisionBetween(1, 100, true, 'blocked');
   	   backgroundLayer.resizeWorld();
   	   player = game.add.sprite(300, 976, 'dude');
   	  game.physics.arcade.enable(player);
   	   door = game.add.group();
   	   door.enableBody = true;
   	   map.createFromObjects('door', 58, 'door', 0, true, false, door);
   	   door2 = game.add.group();
   	   door2.enableBody = true;
   	   map.createFromObjects('door2', 59, 'door2', 0, true, false, door2);
   	   doorS = game.add.group();
   	   doorS.enableBody = true;
   	   map.createFromObjects('specialDoor', 41, 'doorS', 0, true, false, doorS);
   }
   function loadDealer(){
   	   map = game.add.tilemap('dealer');
   	   map.addTilesetImage('dealershipTileset', 'dealerTiles');
   	   var backgroundLayer = map.createLayer('background');
   	   blockTile = map.createLayer('blocked');
   	   map.setCollisionBetween(1, 100, true, 'blocked');
   	   backgroundLayer.resizeWorld();
   	   player2 = game.add.sprite(472, 915, 'dude');
   	   game.physics.arcade.enable(player2);
   	   game.camera.follow(player2);
   	   exit = game.add.group();
   	   exit.enableBody = true;
   	   map.createFromObjects('exit', 29, 'exit', 0, true, false, exit);
   }
   function loadS(){
   	   
   }
   function render(){
   	   game.debug.spriteInfo(player, 32, 32);
   	   game.debug.pointer(game.input.mousePointer);
   }
};
